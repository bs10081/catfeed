{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h1 class="text-center mb-4">ğŸ± æ»…éœ¸çš„é¤µé£Ÿè¨˜éŒ„ ğŸ</h1>
            <p class="text-center text-muted">ä¹Ÿå«é»˜é»˜ã€éºµåŒ… | åŠŸèƒ½å»ºè­°åŠå•é¡Œå›å ±ï¼š<a href="mailto:i@RegChien.info">i@RegChien.info</a></p>
        </div>
    </div>

    <!-- æœ€è¿‘ç…§ç‰‡è¼ªæ’­ -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body p-0">
                    <div class="position-relative">
                        {% if recent_photos %}
                        <div id="recentPhotosCarousel" class="carousel slide" data-bs-ride="carousel">
                            <div class="carousel-inner">
                                {% for photo in recent_photos %}
                                <div class="carousel-item {% if loop.first %}active{% endif %}">
                                    <div class="photo-card" data-bs-toggle="modal" data-bs-target="#viewPhotoModal" 
                                        data-photo-src="{{ url_for('uploaded_file', filename=photo.filename) }}"
                                        data-photo-date="{{ photo.date_taken.strftime('%Y-%m-%d') }}"
                                        data-photo-photographer="{{ photo.photographer }}"
                                        data-photo-description="{{ photo.description or '' }}"
                                        data-photo-filename="{{ photo.original_filename }}">
                                        <img src="{{ url_for('uploaded_file', filename=photo.filename) }}" 
                                             class="d-block w-100 carousel-photo" 
                                             alt="æ»…éœ¸çš„ç…§ç‰‡">
                                        <div class="photo-info">
                                            <p class="photo-date">{{ photo.date_taken.strftime('%Y-%m-%d') }}</p>
                                            {% if photo.description %}
                                            <p class="photo-description">{{ photo.description }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <button class="carousel-control-prev" type="button" data-bs-target="#recentPhotosCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">ä¸Šä¸€å¼µ</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#recentPhotosCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">ä¸‹ä¸€å¼µ</span>
                            </button>
                        </div>
                        {% else %}
                        <div class="empty-photo-placeholder">
                            <div class="text-center py-5">
                                <h5 class="text-muted mb-3">é‚„æ²’æœ‰ç…§ç‰‡</h5>
                                <p class="text-muted">ä¸Šå‚³ç¬¬ä¸€å¼µæ»…éœ¸çš„ç…§ç‰‡å§ï¼</p>
                            </div>
                        </div>
                        {% endif %}
                        <button type="button" 
                                class="btn btn-light btn-upload-photo" 
                                data-bs-toggle="modal" 
                                data-bs-target="#uploadPhotoModal">
                            <i class="bi bi-camera-fill"></i>
                            <span class="upload-text">ä¸Šå‚³ç…§ç‰‡</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
            </div>

            <!-- ç‹€æ…‹æé†’å½ˆçª— -->
            {% if status.message %}
            <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1050;">
                <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="2000" data-bs-autohide="true">
                    <div class="toast-header bg-white">
                        <strong class="me-auto">æ»…éœ¸çš„ç‹€æ…‹</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body bg-{{ status.type }} text-white" style="opacity: 1 !important;">
                        {{ status.message }}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- ä»Šæ—¥æ”å–çµ±è¨ˆ -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">ä»Šæ—¥æ”å–çµ±è¨ˆ</h5>
                    <p>å·²æ”å–: {{ "%.1f"|format(total_calories) }} å¤§å¡ / å»ºè­°é‡: {{ "%.1f"|format(daily_needs) }} å¤§å¡</p>
                    <div class="progress mb-3">
                        <div class="progress-bar {% if total_calories > daily_needs %}bg-danger{% endif %}" 
                             role="progressbar" 
                            style="width: {{ (total_calories/daily_needs*100)|round|int if daily_needs > 0 else 0 }}%">
                        </div>
                    </div>
                    <p class="mb-0">{{ remaining_treats }}</p>
                </div>
            </div>
                </div>
            </div>
            
    <!-- é¤µé£Ÿè¨˜éŒ„è¡¨å–® -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <form action="{{ url_for('add_record') }}" method="post">
                        <div class="row g-3 align-items-center">
                            <div class="col-md">
                        <input type="text" class="form-control" name="feeder_nickname" placeholder="é¤µé£Ÿäººæš±ç¨±" required>
                    </div>
                            <div class="col-md">
                        <select class="form-select" name="food_type" required>
                                    <option value="" selected disabled>é¸æ“‡é£Ÿç‰©é¡å‹</option>
                            <option value="è²“ç½é ­">è²“ç½é ­</option>
                            <option value="è²“æ¢">è²“æ¢</option>
                            <option value="ä¹¾ç³§">ä¹¾ç³§</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                            <div class="col-md">
                        <div class="input-group">
                                    <input type="number" class="form-control" name="amount" placeholder="ä»½é‡" required>
                            <span class="input-group-text">å…‹</span>
                        </div>
                    </div>
                            <div class="col-md-auto">
                                <button type="submit" class="btn btn-record">è¨˜éŒ„</button>
                    </div>
                </div>
                        <div class="row mt-3">
                            <div class="col">
                    <input type="text" class="form-control" name="notes" placeholder="å‚™è¨»ï¼ˆé¸å¡«ï¼‰">
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

            <!-- æœ€è¿‘é¤µé£Ÿè¨˜éŒ„ -->
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title mb-0">æœ€è¿‘é¤µé£Ÿè¨˜éŒ„</h5>
                                <button class="btn btn-link text-decoration-none collapsed" 
                                        type="button" 
                                        data-bs-toggle="collapse" 
                                        data-bs-target="#feedingHistory" 
                                        aria-expanded="false">
                                    <span class="show-text">é¡¯ç¤ºæ›´å¤š</span>
                                    <span class="hide-text d-none">æ”¶èµ·è¨˜éŒ„</span>
                                    <i class="bi bi-chevron-down toggle-icon"></i>
                                </button>
                            </div>
                            
                            <!-- æœ€æ–°çš„5ç­†è¨˜éŒ„ -->
                            <div class="table-responsive recent-records">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>æ™‚é–“</th>
                                            <th>é¤µé£Ÿäºº</th>
                                            <th>é£Ÿç‰©</th>
                                            <th>ä»½é‡</th>
                                            <th>å¡è·¯é‡Œ</th>
                                            <th>å‚™è¨»</th>
                                            <th>æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for record in records[:5] %}
                                        <tr>
                                            <td data-label="æ™‚é–“">{{ record.local_time.strftime('%m/%d %H:%M') if record.local_time else record.timestamp.strftime('%m/%d %H:%M') }}</td>
                                            <td data-label="é¤µé£Ÿäºº">{{ record.feeder_nickname }}</td>
                                            <td data-label="é£Ÿç‰©">{{ record.food_type }}</td>
                                            <td data-label="ä»½é‡">{{ record.amount }} {{ record.unit }}</td>
                                            <td data-label="å¡è·¯é‡Œ">{{ "%.1f"|format(record.calories) }}</td>
                                            <td data-label="å‚™è¨»">{{ record.notes or '' }}</td>
                                            <td>
                                                {% if can_edit_record(record) %}
                                                <div class="d-flex align-items-center justify-content-end">
                                                    <div class="btn-group me-2">
                                                        <a href="#" class="btn btn-sm btn-outline-primary edit-record-btn" 
                                                           data-record-id="{{ record.id }}" 
                                                           data-nickname="{{ record.feeder_nickname }}" 
                                                           data-food-type="{{ record.food_type }}" 
                                                           data-amount="{{ record.amount }}" 
                                                           data-notes="{{ record.notes }}">ç·¨è¼¯</a>
                                                        <form action="{{ url_for('delete_record', record_id=record.id) }}" method="POST" style="display: inline;">
                                                            <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')">åˆªé™¤</button>
                                                        </form>
                                                    </div>
                                                    <small class="text-muted countdown" data-timestamp="{{ record.timestamp.isoformat() }}"></small>
                                                </div>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            <!-- æ­·å²è¨˜éŒ„ -->
                            <div class="collapse" id="feedingHistory">
                                <div class="history-divider">
                                    <span>æ­·å²è¨˜éŒ„</span>
                                </div>
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead class="d-none">
                                            <tr>
                                                <th>æ™‚é–“</th>
                                                <th>é¤µé£Ÿäºº</th>
                                                <th>é£Ÿç‰©</th>
                                                <th>ä»½é‡</th>
                                                <th>å¡è·¯é‡Œ</th>
                                                <th>å‚™è¨»</th>
                                                <th>æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for record in records[5:] %}
                                            <tr class="history-record">
                                                <td data-label="æ™‚é–“">{{ record.local_time.strftime('%m/%d %H:%M') if record.local_time else record.timestamp.strftime('%m/%d %H:%M') }}</td>
                                                <td data-label="é¤µé£Ÿäºº">{{ record.feeder_nickname }}</td>
                                                <td data-label="é£Ÿç‰©">{{ record.food_type }}</td>
                                                <td data-label="ä»½é‡">{{ record.amount }} {{ record.unit }}</td>
                                                <td data-label="å¡è·¯é‡Œ">{{ "%.1f"|format(record.calories) }}</td>
                                                <td data-label="å‚™è¨»">{{ record.notes or '' }}</td>
                                                <td>
                                                    {% if can_edit_record(record) %}
                                                    <div class="d-flex align-items-center justify-content-end">
                                                        <div class="btn-group me-2">
                                                            <a href="#" class="btn btn-sm btn-outline-primary edit-record-btn" 
                                                               data-record-id="{{ record.id }}" 
                                                               data-nickname="{{ record.feeder_nickname }}" 
                                                               data-food-type="{{ record.food_type }}" 
                                                               data-amount="{{ record.amount }}" 
                                                               data-notes="{{ record.notes }}">ç·¨è¼¯</a>
                                                            <form action="{{ url_for('delete_record', record_id=record.id) }}" method="POST" style="display: inline;">
                                                                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')">åˆªé™¤</button>
                                                            </form>
                                                        </div>
                                                        <small class="text-muted countdown" data-timestamp="{{ record.timestamp.isoformat() }}"></small>
                                                    </div>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
</div>
</div>

<!-- ç…§ç‰‡æŸ¥çœ‹ Modal -->
<div class="modal fade" id="viewPhotoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-0">
                <img src="" class="view-photo-img img-fluid" alt="ç…§ç‰‡å¤§åœ–">
            </div>
            <div class="modal-footer">
                <div class="photo-details text-start flex-grow-1">
                    <p class="mb-1"><strong>æ‹æ”æ—¥æœŸï¼š</strong><span class="view-photo-date"></span></p>
                    <p class="mb-1"><strong>æ‹æ”è€…ï¼š</strong><span class="view-photo-photographer"></span></p>
                    <p class="mb-1 view-photo-description-container"><strong>æè¿°ï¼š</strong><span class="view-photo-description"></span></p>
                </div>
                <a href="#" class="btn btn-primary download-photo" download>ä¸‹è¼‰ç…§ç‰‡</a>
            </div>
        </div>
    </div>
</div>

<!-- ä¸Šå‚³ç…§ç‰‡ Modal -->
<div class="modal fade" id="uploadPhotoModal" tabindex="-1" aria-labelledby="uploadPhotoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadPhotoModalLabel">ä¸Šå‚³æ»…éœ¸çš„ç…§ç‰‡</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="uploadPhotoForm" action="{{ url_for('upload_photo') }}" method="post" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="photo" class="form-label">é¸æ“‡ç…§ç‰‡</label>
                        <input type="file" class="form-control" id="photo" name="photo" accept="image/jpeg,image/png,image/heic" required>
                        <div class="form-text">æ”¯æ´ JPGã€PNGã€HEIC æ ¼å¼çš„ç…§ç‰‡</div>
                    </div>
                    <div class="mb-3">
                        <label for="dateTaken" class="form-label">æ‹æ”æ—¥æœŸ</label>
                        <input type="date" class="form-control" id="dateTaken" name="date_taken" required>
                    </div>
                    <div class="mb-3">
                        <label for="photographer" class="form-label">æ‹æ”è€…</label>
                        <input type="text" class="form-control" id="photographer" name="photographer" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">æè¿°ï¼ˆé¸å¡«ï¼‰</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">ä¸Šå‚³</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ç·¨è¼¯è¨˜éŒ„çš„ Modal -->
<div class="modal fade" id="editRecordModal" tabindex="-1" aria-labelledby="editRecordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editRecordModalLabel">ç·¨è¼¯é¤µé£Ÿè¨˜éŒ„</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editRecordForm" method="post">
                    <div class="mb-3">
                        <input type="text" class="form-control" name="feeder_nickname" id="editFeederNickname" placeholder="é¤µé£Ÿäººæš±ç¨±" required>
                    </div>
                    <div class="mb-3">
                        <select class="form-select" name="food_type" id="editFoodType" required>
                            <option value="" disabled>é¸æ“‡é£Ÿç‰©é¡å‹</option>
                            <option value="è²“ç½é ­">è²“ç½é ­</option>
                            <option value="è²“æ¢">è²“æ¢</option>
                            <option value="ä¹¾ç³§">ä¹¾ç³§</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="input-group">
                            <input type="number" class="form-control" name="amount" id="editAmount" placeholder="ä»½é‡" required>
                            <span class="input-group-text">å…‹</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <input type="text" class="form-control" name="notes" id="editNotes" placeholder="å‚™è¨»ï¼ˆé¸å¡«ï¼‰">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="submitEditForm()">æ›´æ–°è¨˜éŒ„</button>
            </div>
        </div>
    </div>
</div>

<style>
.carousel-photo {
    height: 300px;
    object-fit: cover;
    border-radius: 1.618rem;
}

.photo-card {
    position: relative;
    width: 100%;
    height: 100%;
    cursor: pointer;
    overflow: hidden;
    border-radius: 1.618rem;
}

.photo-info {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,0.7));
    color: white;
    padding: 1rem;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.photo-card:hover .photo-info {
    opacity: 1;
}

.photo-date, .photo-description {
    margin: 0;
    font-size: 0.9rem;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}

.photo-description {
    margin-top: 0.5rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

#viewPhotoModal .modal-content {
    background-color: rgba(255,255,255,0.95);
}

#viewPhotoModal .modal-body {
    max-height: 80vh;
    display: flex;
    align-items: center;
    justify-content: center;
}

.view-photo-img {
    max-height: 70vh;
    object-fit: contain;
}

.photo-details {
    font-size: 0.9rem;
}

.carousel-control-prev,
.carousel-control-next {
    width: 5%;
    background: rgba(0,0,0,0.3);
}

.carousel-control-prev:hover,
.carousel-control-next:hover {
    background: rgba(0,0,0,0.5);
}

.btn-upload-photo {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background-color: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 1rem;
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
    backdrop-filter: blur(5px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    z-index: 10;
}

.btn-upload-photo:hover {
    background-color: rgba(255, 255, 255, 1);
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    transform: translateY(-1px);
}

.btn-upload-photo i {
    margin-right: 0.5rem;
}

.empty-photo-placeholder {
    height: 300px;
    background-color: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 1.618rem;
}

.card {
    border-radius: 1.618rem;
    overflow: hidden;
}

@media (max-width: 768px) {
    .carousel-photo,
    .photo-card,
    .empty-photo-placeholder,
    .card {
        border-radius: 1.2rem;
    }
    
    .btn-upload-photo {
        border-radius: 0.75rem;
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
    }
}

.modal-content {
    border: none;
    border-radius: 1.618rem;
    overflow: hidden;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
}

.modal-header {
    padding: calc(1.618rem - 1rem) 1.618rem;
    background-color: #f8f9fa;
    border-bottom: 1px solid rgba(0,0,0,0.1);
}

.modal-body {
    padding: 1.618rem;
}

.modal-body img {
    border-radius: 0;
    max-height: 80vh;
    object-fit: contain;
}

.modal-footer {
    padding: calc(1.618rem - 1rem) 1.618rem;
    background-color: #f8f9fa;
    border-top: 1px solid rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 1rem;
}

.photo-details {
    background-color: white;
    padding: 1rem;
    border-radius: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    flex-grow: 1;
}

.download-photo {
    border-radius: 1rem;
    padding: 0.75rem 1.5rem;
    font-weight: 500;
    transition: all 0.3s ease;
    flex-shrink: 0;
}

.btn-close {
    background-color: rgba(255,255,255,0.8);
    border-radius: 50%;
    padding: 0.75rem;
    margin: 0.5rem;
    transition: all 0.3s ease;
}

.btn-close:hover {
    background-color: rgba(255,255,255,1);
    transform: rotate(90deg);
}

@media (max-width: 768px) {
    .modal-content {
        border-radius: 1.2rem;
    }
    
    .modal-header,
    .modal-body,
    .modal-footer {
        padding: calc(1.2rem - 0.75rem) 1.2rem;
    }
    
    .photo-details {
        margin-right: 0;
        width: 100%;
        border-radius: 0.75rem;
    }
    
    .download-photo {
        width: 100%;
        border-radius: 0.75rem;
        padding: 0.5rem 1rem;
    }
    
    .btn-close {
        padding: 0.5rem;
    }
}

.btn-record {
    border-radius: 1.618rem;
    padding: 0.75rem 2rem;
    font-size: 1rem;
    font-weight: 500;
    background-color: #0d6efd;
    border: none;
    color: white;
    transition: all 0.3s ease;
    min-width: 120px;
}

.btn-record:hover {
    background-color: #0b5ed7;
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
}

@media (max-width: 768px) {
    .btn-record {
        border-radius: 1.2rem;
        padding: 0.5rem 1.5rem;
        font-size: 0.9rem;
        min-width: 100px;
    }
}

.form-control, .form-select {
    border-radius: 1rem;
    border: 1px solid rgba(0,0,0,0.1);
    padding: 0.75rem 1rem;
    transition: all 0.3s ease;
    background-color: #f8f9fa;
}

.form-control:focus, .form-select:focus {
    border-color: rgba(13,110,253,0.5);
    box-shadow: 0 0 0 0.2rem rgba(13,110,253,0.15);
    background-color: white;
}

.input-group {
    border-radius: 1rem;
    overflow: hidden;
    background-color: #f8f9fa;
    border: 1px solid rgba(0,0,0,0.1);
}

.input-group .form-control {
    border-radius: 0;
    border: none;
    border-right: none;
    background-color: #f8f9fa;
}

.input-group .form-control:focus {
    border: none;
    background-color: white;
    box-shadow: none;
}

.input-group-text {
    border: none;
    background-color: #f8f9fa;
    color: #212529;
    padding: 0.75rem 1rem;
    border-left: 1px solid rgba(0,0,0,0.1);
}

.input-group:focus-within {
    border-color: rgba(0,0,0,0.2);
    box-shadow: 0 0 0 0.2rem rgba(0,0,0,0.05);
}

.input-group:focus-within .input-group-text {
    background-color: white;
}

@media (max-width: 768px) {
    .form-control, .form-select {
        border-radius: 0.75rem;
        padding: 0.5rem 0.75rem;
        font-size: 0.9rem;
    }
    
    .input-group {
        border-radius: 0.75rem;
    }
    
    .input-group-text {
        padding: 0.5rem 0.75rem;
        font-size: 0.9rem;
    }
}

.form-text {
    color: #6c757d;
    margin-top: 0.5rem;
    font-size: 0.875rem;
}

.form-control[type="file"] {
    position: relative;
    padding: calc(1.618rem - 0.5rem) 1.618rem;
    background-color: #f8f9fa;
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 1.618rem;
    cursor: pointer;
}

.form-control[type="file"]::file-selector-button {
    border: none;
    border-radius: 100vh;  /* æœ€å¤§åœ“è§’ */
    padding: 0.375rem 1.5rem;  /* åŠ å¯¬æŒ‰éˆ• */
    margin-right: 1rem;
    color: white;
    background-color: #0d6efd;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.875rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.form-control[type="file"]::file-selector-button:hover {
    background-color: #0b5ed7;
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
}

button.btn.btn-primary {
    border-radius: 1.618rem;
    padding: 0.75rem 2rem;
    font-size: 1rem;
    font-weight: 500;
    background-color: #0d6efd;
    border: none;
    color: white;
    transition: all 0.3s ease;
    min-width: 120px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

button.btn.btn-primary:hover {
    background-color: #0b5ed7;
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
}

button.btn.btn-secondary {
    border-radius: 1.618rem;
    padding: 0.75rem 2rem;
    font-size: 1rem;
    font-weight: 500;
    background-color: white;
    border: 1px solid rgba(0,0,0,0.1);
    color: #212529;
    transition: all 0.3s ease;
    min-width: 120px;
}

button.btn.btn-secondary:hover {
    background-color: #f8f9fa;
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
}

@media (max-width: 768px) {
    button.btn.btn-primary,
    button.btn.btn-secondary {
        border-radius: 1.2rem;
        padding: 0.5rem 1.5rem;
        font-size: 0.9rem;
        min-width: 100px;
    }
}

/* ç·¨è¼¯å’Œåˆªé™¤æŒ‰éˆ•æ¨£å¼ */
.btn-group {
    box-shadow: none;
    vertical-align: middle;
}

.btn-sm.btn-outline-primary,
.btn-sm.btn-outline-danger {
    border-radius: 0;
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.3s ease;
    border: none;
    margin: 0;
}

.btn-sm.btn-outline-primary {
    color: white;
    background-color: #0d6efd;
    border-top-left-radius: 1.618rem;
    border-bottom-left-radius: 1.618rem;
}

.btn-sm.btn-outline-primary:hover {
    background-color: #0b5ed7;
    transform: translateY(-1px);
}

.btn-sm.btn-outline-danger {
    color: white;
    background-color: #dc3545;
    border-top-right-radius: 1.618rem;
    border-bottom-right-radius: 1.618rem;
}

.btn-sm.btn-outline-danger:hover {
    background-color: #bb2d3b;
    transform: translateY(-1px);
}

@media (max-width: 768px) {
    .btn-sm.btn-outline-primary,
    .btn-sm.btn-outline-danger {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    }
    
    .btn-sm.btn-outline-primary {
        border-top-left-radius: 1.2rem;
        border-bottom-left-radius: 1.2rem;
    }
    
    .btn-sm.btn-outline-danger {
        border-top-right-radius: 1.2rem;
        border-bottom-right-radius: 1.2rem;
    }
}

/* æ‰‹æ©Ÿç‰ˆè¡¨æ ¼å„ªåŒ– */
@media (max-width: 768px) {
    .table-responsive {
        border: none;
    }
    
    .table thead {
        display: none;  /* éš±è—è¡¨é ­ */
    }
    
    .table, .table tbody, .table tr, .table td {
        display: block;
        width: 100%;
    }
    
    .table tr {
        background-color: #fff;
        border-radius: 1.2rem;
        margin-bottom: 1rem;
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .table td {
        position: relative;
        padding: 0.5rem 0;
        border: none;
        text-align: right;
        padding-left: 40%;  /* ç‚ºæ¨™ç±¤é ç•™ç©ºé–“ */
    }
    
    .table td:before {
        content: attr(data-label);
        position: absolute;
        left: 0;
        width: 35%;
        text-align: left;
        color: #6c757d;
        font-weight: 500;
        font-size: 0.9rem;
    }
    
    .table td:last-child {
        padding-left: 0;  /* æ“ä½œæ¬„ä½ä¸éœ€è¦æ¨™ç±¤ */
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    /* èª¿æ•´æŒ‰éˆ•çµ„çš„æ¨£å¼ */
    .btn-group {
        display: flex;
        gap: 0.5rem;
    }

    .btn-sm.btn-outline-primary,
    .btn-sm.btn-outline-danger {
        border-radius: 1.2rem !important;  /* å¼·åˆ¶è¦†è“‹ä¹‹å‰çš„æ¨£å¼ */
        padding: 0.375rem 1rem;
        min-width: 60px;
    }

    /* å€’è¨ˆæ™‚æ–‡å­—æ¨£å¼ */
    .countdown {
        font-size: 0.8rem;
        white-space: nowrap;
        margin-left: 0.5rem;
    }

    /* èª¿æ•´è¡¨å–®åœ¨æ‰‹æ©Ÿç‰ˆçš„ä½ˆå±€ */
    .row.g-3 .col-md {
        margin-bottom: 0.5rem;
    }

    .input-group {
        margin-bottom: 0.5rem;
    }

    .btn-record {
        width: 100%;
        margin-top: 0.5rem;
    }
}

/* æ·»åŠ æ­·å²è¨˜éŒ„ç›¸é—œæ¨£å¼ */
.history-divider {
    position: relative;
    text-align: center;
    margin: 2rem 0 1.5rem;
}

.history-divider:before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 1px;
    background: rgba(0,0,0,0.1);
}

.history-divider span {
    position: relative;
    background: white;
    padding: 0.5rem 1rem;
    color: #6c757d;
    font-size: 0.9rem;
    border-radius: 1rem;
    border: 1px solid rgba(0,0,0,0.1);
}

.history-record {
    opacity: 0;
    transform: translateY(10px);
    animation: fadeInUp 0.3s ease forwards;
}

@keyframes fadeInUp {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.btn-link {
    color: #6c757d;
    padding: 0.5rem 1rem;
    border-radius: 1rem;
    transition: all 0.3s ease;
}

.btn-link:hover {
    background-color: rgba(0,0,0,0.05);
    color: #0d6efd;
}

.btn-link .toggle-icon {
    transition: transform 0.3s ease;
    display: inline-block;
    margin-left: 0.25rem;
}

.btn-link.collapsed .toggle-icon {
    transform: rotate(0deg);
}

.btn-link:not(.collapsed) .toggle-icon {
    transform: rotate(180deg);
}

.btn-link:not(.collapsed) .show-text {
    display: none;
}

.btn-link:not(.collapsed) .hide-text {
    display: inline !important;
}

.btn-link.collapsed .hide-text {
    display: none !important;
}

.btn-link.collapsed .show-text {
    display: inline;
}

/* æ‰‹æ©Ÿç‰ˆå„ªåŒ– */
@media (max-width: 768px) {
    .history-divider {
        margin: 1.5rem 0 1rem;
    }

    .history-divider span {
        font-size: 0.8rem;
        padding: 0.375rem 0.75rem;
    }

    .btn-link {
        padding: 0.375rem 0.75rem;
        font-size: 0.9rem;
    }
}
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    const viewModal = document.getElementById('viewPhotoModal');
    viewModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const photoSrc = button.getAttribute('data-photo-src');
        const photoDate = button.getAttribute('data-photo-date');
        const photoPhotographer = button.getAttribute('data-photo-photographer');
        const photoDescription = button.getAttribute('data-photo-description');
        const photoFilename = button.getAttribute('data-photo-filename');

        const modalImg = viewModal.querySelector('.view-photo-img');
        const modalDate = viewModal.querySelector('.view-photo-date');
        const modalPhotographer = viewModal.querySelector('.view-photo-photographer');
        const modalDescription = viewModal.querySelector('.view-photo-description');
        const modalDescriptionContainer = viewModal.querySelector('.view-photo-description-container');
        const downloadBtn = viewModal.querySelector('.download-photo');

        modalImg.src = photoSrc;
        modalDate.textContent = photoDate;
        modalPhotographer.textContent = photoPhotographer;
        
        if (photoDescription) {
            modalDescription.textContent = photoDescription;
            modalDescriptionContainer.style.display = 'block';
        } else {
            modalDescriptionContainer.style.display = 'none';
        }

        downloadBtn.href = photoSrc;
        downloadBtn.download = photoFilename;
    });

    // è‡ªå‹•è¼ªæ’­è¨­å®š
    const carousel = new bootstrap.Carousel(document.getElementById('recentPhotosCarousel'), {
        interval: 5000,  // 5ç§’åˆ‡æ›ä¸€æ¬¡
        wrap: true
    });

    // è¨­å®šé è¨­çš„æ‹æ”æ—¥æœŸç‚ºä»Šå¤©
    const dateTaken = document.getElementById('dateTaken');
    if (dateTaken) {
        const today = new Date().toISOString().split('T')[0];
        dateTaken.value = today;
    }

    // ä¸Šå‚³è¡¨å–®æäº¤å‰çš„è™•ç†
    const uploadForm = document.getElementById('uploadPhotoForm');
    if (uploadForm) {
        uploadForm.addEventListener('submit', function(e) {
            const submitButton = this.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ä¸Šå‚³ä¸­...';
        });
    }

    // æ›´æ–°æ‰€æœ‰å€’è¨ˆæ™‚
    function updateCountdowns() {
        document.querySelectorAll('.countdown').forEach(function(element) {
            const timestamp = new Date(element.dataset.timestamp + 'Z');  // æ·»åŠ  'Z' ç¢ºä¿è§£æç‚º UTC
            const now = new Date();
            const diffMs = timestamp.getTime() + 15 * 60 * 1000 - now.getTime();
            const diffMinutes = Math.ceil(diffMs / (1000 * 60));  // ä½¿ç”¨ Math.ceil å‘ä¸Šå–æ•´
            
            if (diffMinutes > 0) {
                element.textContent = `å‰©ä¸‹ ${diffMinutes} åˆ†é˜`;
                const row = element.closest('tr');
                if (row) {
                    const btnGroup = row.querySelector('.btn-group');
                    if (btnGroup) {
                        btnGroup.style.display = 'flex';
                    }
                }
            } else {
                const row = element.closest('tr');
                if (row) {
                    const operationCell = row.querySelector('td:last-child');
                    if (operationCell) {
                        operationCell.innerHTML = '<span class="text-muted">å·²è¶…éå¯ç·¨è¼¯æ™‚é–“</span>';
                    }
                }
            }
        });
    }

    // åˆå§‹æ›´æ–°
    updateCountdowns();

    // æ¯10ç§’æ›´æ–°ä¸€æ¬¡
    setInterval(updateCountdowns, 10000);  // æ”¹ç‚ºæ¯10ç§’æ›´æ–°ä¸€æ¬¡ï¼Œä½¿é¡¯ç¤ºæ›´å³æ™‚

    // ç·¨è¼¯è¨˜éŒ„ç›¸é—œåŠŸèƒ½
    function openEditModal(recordId, nickname, foodType, amount, notes) {
        const modal = new bootstrap.Modal(document.getElementById('editRecordModal'));
        const form = document.getElementById('editRecordForm');
        
        // è¨­ç½®è¡¨å–®å‹•ä½œ
        form.action = `/edit_record/${recordId}`;
        
        // å¡«å……è¡¨å–®æ•¸æ“š
        document.getElementById('editFeederNickname').value = nickname;
        document.getElementById('editFoodType').value = foodType;
        document.getElementById('editAmount').value = amount;
        document.getElementById('editNotes').value = notes || '';
        
        modal.show();
    }

    function submitEditForm() {
        const form = document.getElementById('editRecordForm');
        form.submit();
    }

    // ç‚ºæ‰€æœ‰ç·¨è¼¯æŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½å™¨
    document.querySelectorAll('.edit-record-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const recordData = this.dataset;
            openEditModal(
                recordData.recordId,
                recordData.nickname,
                recordData.foodType,
                recordData.amount,
                recordData.notes
            );
        });
    });

    // æ·»åŠ å±•é–‹/æ”¶èµ·çš„å‹•ç•«æ•ˆæœ
    const feedingHistory = document.getElementById('feedingHistory');
    if (feedingHistory) {
        feedingHistory.addEventListener('show.bs.collapse', function() {
            const records = this.getElementsByClassName('history-record');
            Array.from(records).forEach((record, index) => {
                record.style.animationDelay = `${index * 0.1}s`;
            });
        });
    }
});
</script>
{% endblock %}