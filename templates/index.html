{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h1 class="text-center mb-4">ğŸ± æ»…éœ¸çš„é¤µé£Ÿè¨˜éŒ„ ğŸ</h1>
            <p class="text-center text-muted">ä¹Ÿå«é»˜é»˜ã€ç†Šè€å¤§</p>
        </div>
    </div>

    <!-- æœ€è¿‘ç…§ç‰‡è¼ªæ’­ -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body p-0">
                    <div class="position-relative">
                        {% if recent_photos %}
                        <div id="recentPhotosCarousel" class="carousel slide" data-bs-ride="carousel">
                            <div class="carousel-inner">
                                {% for photo in recent_photos %}
                                <div class="carousel-item {% if loop.first %}active{% endif %}">
                                    <div class="photo-card" data-bs-toggle="modal" data-bs-target="#viewPhotoModal" 
                                        data-photo-src="{{ url_for('uploaded_file', filename=photo.filename) }}"
                                        data-photo-date="{{ photo.date_taken.strftime('%Y-%m-%d') }}"
                                        data-photo-photographer="{{ photo.photographer }}"
                                        data-photo-description="{{ photo.description or '' }}"
                                        data-photo-filename="{{ photo.original_filename }}">
                                        <img src="{{ url_for('uploaded_file', filename=photo.filename) }}" 
                                             class="d-block w-100 carousel-photo" 
                                             alt="æ»…éœ¸çš„ç…§ç‰‡">
                                        <div class="photo-info">
                                            <p class="photo-date">{{ photo.date_taken.strftime('%Y-%m-%d') }}</p>
                                            {% if photo.description %}
                                            <p class="photo-description">{{ photo.description }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <button class="carousel-control-prev" type="button" data-bs-target="#recentPhotosCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">ä¸Šä¸€å¼µ</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#recentPhotosCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">ä¸‹ä¸€å¼µ</span>
                            </button>
                        </div>
                        {% else %}
                        <div class="empty-photo-placeholder">
                            <div class="text-center py-5">
                                <h5 class="text-muted mb-3">é‚„æ²’æœ‰ç…§ç‰‡</h5>
                                <p class="text-muted">ä¸Šå‚³ç¬¬ä¸€å¼µæ»…éœ¸çš„ç…§ç‰‡å§ï¼</p>
                            </div>
                        </div>
                        {% endif %}
                        <button type="button" 
                                class="btn btn-light btn-upload-photo" 
                                data-bs-toggle="modal" 
                                data-bs-target="#uploadPhotoModal">
                            <i class="bi bi-camera-fill"></i>
                            <span class="upload-text">ä¸Šå‚³ç…§ç‰‡</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç‹€æ…‹æé†’å½ˆçª— -->
    {% if status.message %}
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1050;">
        <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="2000" data-bs-autohide="true">
            <div class="toast-header bg-white">
                <strong class="me-auto">æ»…éœ¸çš„ç‹€æ…‹</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body bg-{{ status.type }} text-white" style="opacity: 1 !important;">
                {{ status.message }}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ä»Šæ—¥æ”å–çµ±è¨ˆ -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">ä»Šæ—¥æ”å–çµ±è¨ˆ</h5>
                    <p>å·²æ”å–: {{ "%.1f"|format(total_calories) }} å¤§å¡ / å»ºè­°é‡: {{ "%.1f"|format(daily_needs) }} å¤§å¡</p>
                    <div class="progress mb-3">
                        <div class="progress-bar {% if total_calories > daily_needs %}bg-danger{% endif %}" 
                             role="progressbar" 
                             style="width: {{ (total_calories/daily_needs*100)|round|int if daily_needs > 0 else 0 }}%">
                        </div>
                    </div>
                    <p class="mb-0">{{ remaining_treats }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- é¤µé£Ÿè¨˜éŒ„è¡¨å–® -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <form action="{{ url_for('add_record') }}" method="POST" class="row g-3">
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="feeder_nickname" name="feeder_nickname" placeholder="é¤µé£Ÿäººæš±ç¨±" required>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="food_type" name="food_type" required>
                                <option value="" disabled selected>é¸æ“‡é£Ÿç‰©é¡å‹</option>
                                <option value="è²“ç½é ­">è²“ç½é ­</option>
                                <option value="è²“æ¢">è²“æ¢</option>
                                <option value="ä¹¾ç³§">ä¹¾ç³§</option>
                                <option value="å…¶ä»–">å…¶ä»–</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <div class="input-group">
                                <input type="number" class="form-control" id="amount" name="amount" step="0.1" min="0" placeholder="ä»½é‡" required>
                                <span class="input-group-text">å…‹</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary w-100">è¨˜éŒ„</button>
                        </div>
                        <div class="col-12">
                            <input type="text" class="form-control" id="notes" name="notes" placeholder="å‚™è¨»ï¼ˆé¸å¡«ï¼‰">
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- æœ€è¿‘é¤µé£Ÿè¨˜éŒ„ -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">æœ€è¿‘é¤µé£Ÿè¨˜éŒ„</h5>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>æ™‚é–“</th>
                                    <th>é¤µé£Ÿäºº</th>
                                    <th>é£Ÿç‰©</th>
                                    <th>ä»½é‡</th>
                                    <th>å¡è·¯é‡Œ</th>
                                    <th>å‚™è¨»</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in records %}
                                <tr>
                                    <td>{{ record.local_time.strftime('%m/%d %H:%M') if record.local_time else record.timestamp.strftime('%m/%d %H:%M') }}</td>
                                    <td>{{ record.feeder_nickname }}</td>
                                    <td>{{ record.food_type }}</td>
                                    <td>{{ record.amount }} {{ record.unit }}</td>
                                    <td>{{ "%.1f"|format(record.calories) }}</td>
                                    <td>{{ record.notes or '' }}</td>
                                    <td>
                                        {% if can_edit_record(record) %}
                                        <div class="btn-group">
                                            <a href="{{ url_for('edit_record', record_id=record.id) }}" class="btn btn-sm btn-outline-primary">ç·¨è¼¯</a>
                                            <form action="{{ url_for('delete_record', record_id=record.id) }}" method="POST" style="display: inline;">
                                                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')">åˆªé™¤</button>
                                            </form>
                                        </div>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç…§ç‰‡æŸ¥çœ‹ Modal -->
<div class="modal fade" id="viewPhotoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-0">
                <img src="" class="view-photo-img img-fluid" alt="ç…§ç‰‡å¤§åœ–">
            </div>
            <div class="modal-footer">
                <div class="photo-details text-start flex-grow-1">
                    <p class="mb-1"><strong>æ‹æ”æ—¥æœŸï¼š</strong><span class="view-photo-date"></span></p>
                    <p class="mb-1"><strong>æ‹æ”è€…ï¼š</strong><span class="view-photo-photographer"></span></p>
                    <p class="mb-1 view-photo-description-container"><strong>æè¿°ï¼š</strong><span class="view-photo-description"></span></p>
                </div>
                <a href="#" class="btn btn-primary download-photo" download>ä¸‹è¼‰ç…§ç‰‡</a>
            </div>
        </div>
    </div>
</div>

<!-- ä¸Šå‚³ç…§ç‰‡ Modal -->
<div class="modal fade" id="uploadPhotoModal" tabindex="-1" aria-labelledby="uploadPhotoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadPhotoModalLabel">ä¸Šå‚³æ»…éœ¸çš„ç…§ç‰‡</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="uploadPhotoForm" action="{{ url_for('upload_photo') }}" method="post" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="photo" class="form-label">é¸æ“‡ç…§ç‰‡</label>
                        <input type="file" class="form-control" id="photo" name="photo" accept="image/*" required>
                        <div class="form-text">æ”¯æ´ JPGã€PNG æ ¼å¼çš„ç…§ç‰‡</div>
                    </div>
                    <div class="mb-3">
                        <label for="dateTaken" class="form-label">æ‹æ”æ—¥æœŸ</label>
                        <input type="date" class="form-control" id="dateTaken" name="date_taken" required>
                    </div>
                    <div class="mb-3">
                        <label for="photographer" class="form-label">æ‹æ”è€…</label>
                        <input type="text" class="form-control" id="photographer" name="photographer" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">æè¿°ï¼ˆé¸å¡«ï¼‰</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">ä¸Šå‚³</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
.carousel-photo {
    height: 300px;
    object-fit: cover;
    border-radius: 1.618rem;
}

.photo-card {
    position: relative;
    width: 100%;
    height: 100%;
    cursor: pointer;
    overflow: hidden;
    border-radius: 1.618rem;
}

.photo-info {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,0.7));
    color: white;
    padding: 1rem;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.photo-card:hover .photo-info {
    opacity: 1;
}

.photo-date, .photo-description {
    margin: 0;
    font-size: 0.9rem;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}

.photo-description {
    margin-top: 0.5rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

#viewPhotoModal .modal-content {
    background-color: rgba(255,255,255,0.95);
}

#viewPhotoModal .modal-body {
    max-height: 80vh;
    display: flex;
    align-items: center;
    justify-content: center;
}

.view-photo-img {
    max-height: 70vh;
    object-fit: contain;
}

.photo-details {
    font-size: 0.9rem;
}

.carousel-control-prev,
.carousel-control-next {
    width: 5%;
    background: rgba(0,0,0,0.3);
}

.carousel-control-prev:hover,
.carousel-control-next:hover {
    background: rgba(0,0,0,0.5);
}

.btn-upload-photo {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background-color: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 1rem;
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
    backdrop-filter: blur(5px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    z-index: 10;
}

.btn-upload-photo:hover {
    background-color: rgba(255, 255, 255, 1);
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    transform: translateY(-1px);
}

.btn-upload-photo i {
    margin-right: 0.5rem;
}

.empty-photo-placeholder {
    height: 300px;
    background-color: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 1.618rem;
}

.card {
    border-radius: 1.618rem;
    overflow: hidden;
}

@media (max-width: 768px) {
    .carousel-photo,
    .photo-card,
    .empty-photo-placeholder,
    .card {
        border-radius: 1.2rem;
    }
    
    .btn-upload-photo {
        border-radius: 0.75rem;
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const viewModal = document.getElementById('viewPhotoModal');
    viewModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const photoSrc = button.getAttribute('data-photo-src');
        const photoDate = button.getAttribute('data-photo-date');
        const photoPhotographer = button.getAttribute('data-photo-photographer');
        const photoDescription = button.getAttribute('data-photo-description');
        const photoFilename = button.getAttribute('data-photo-filename');

        const modalImg = viewModal.querySelector('.view-photo-img');
        const modalDate = viewModal.querySelector('.view-photo-date');
        const modalPhotographer = viewModal.querySelector('.view-photo-photographer');
        const modalDescription = viewModal.querySelector('.view-photo-description');
        const modalDescriptionContainer = viewModal.querySelector('.view-photo-description-container');
        const downloadBtn = viewModal.querySelector('.download-photo');

        modalImg.src = photoSrc;
        modalDate.textContent = photoDate;
        modalPhotographer.textContent = photoPhotographer;
        
        if (photoDescription) {
            modalDescription.textContent = photoDescription;
            modalDescriptionContainer.style.display = 'block';
        } else {
            modalDescriptionContainer.style.display = 'none';
        }

        downloadBtn.href = photoSrc;
        downloadBtn.download = photoFilename;
    });

    // è‡ªå‹•è¼ªæ’­è¨­å®š
    const carousel = new bootstrap.Carousel(document.getElementById('recentPhotosCarousel'), {
        interval: 5000,  // 5ç§’åˆ‡æ›ä¸€æ¬¡
        wrap: true
    });

    // è¨­å®šé è¨­çš„æ‹æ”æ—¥æœŸç‚ºä»Šå¤©
    const dateTaken = document.getElementById('dateTaken');
    if (dateTaken) {
        const today = new Date().toISOString().split('T')[0];
        dateTaken.value = today;
    }

    // ä¸Šå‚³è¡¨å–®æäº¤å‰çš„è™•ç†
    const uploadForm = document.getElementById('uploadPhotoForm');
    if (uploadForm) {
        uploadForm.addEventListener('submit', function(e) {
            const submitButton = this.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ä¸Šå‚³ä¸­...';
        });
    }
});
</script>
{% endblock %}