{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h1 class="text-center mb-4">üê± ÊªÖÈú∏ÁöÑÈ§µÈ£üË®òÈåÑ üçû</h1>
            <p class="text-center text-muted">‰πüÂè´ÈªòÈªò„ÄÅÁÜäËÄÅÂ§ß</p>
        </div>
    </div>

    <!-- ÊúÄËøëÁÖßÁâáËº™Êí≠ -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body p-0">
                    <div class="position-relative">
                        {% if recent_photos %}
                        <div id="recentPhotosCarousel" class="carousel slide" data-bs-ride="carousel">
                            <div class="carousel-inner">
                                {% for photo in recent_photos %}
                                <div class="carousel-item {% if loop.first %}active{% endif %}">
                                    <div class="photo-card" data-bs-toggle="modal" data-bs-target="#viewPhotoModal" 
                                        data-photo-src="{{ url_for('uploaded_file', filename=photo.filename) }}"
                                        data-photo-date="{{ photo.date_taken.strftime('%Y-%m-%d') }}"
                                        data-photo-photographer="{{ photo.photographer }}"
                                        data-photo-description="{{ photo.description or '' }}"
                                        data-photo-filename="{{ photo.original_filename }}">
                                        <img src="{{ url_for('uploaded_file', filename=photo.filename) }}" 
                                             class="d-block w-100 carousel-photo" 
                                             alt="ÊªÖÈú∏ÁöÑÁÖßÁâá">
                                        <div class="photo-info">
                                            <p class="photo-date">{{ photo.date_taken.strftime('%Y-%m-%d') }}</p>
                                            {% if photo.description %}
                                            <p class="photo-description">{{ photo.description }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <button class="carousel-control-prev" type="button" data-bs-target="#recentPhotosCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">‰∏ä‰∏ÄÂºµ</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#recentPhotosCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">‰∏ã‰∏ÄÂºµ</span>
                            </button>
                        </div>
                        {% else %}
                        <div class="empty-photo-placeholder">
                            <div class="text-center py-5">
                                <h5 class="text-muted mb-3">ÈÇÑÊ≤íÊúâÁÖßÁâá</h5>
                                <p class="text-muted">‰∏äÂÇ≥Á¨¨‰∏ÄÂºµÊªÖÈú∏ÁöÑÁÖßÁâáÂêßÔºÅ</p>
                            </div>
                        </div>
                        {% endif %}
                        <button type="button" 
                                class="btn btn-light btn-upload-photo" 
                                data-bs-toggle="modal" 
                                data-bs-target="#uploadPhotoModal">
                            <i class="bi bi-camera-fill"></i>
                            <span class="upload-text">‰∏äÂÇ≥ÁÖßÁâá</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÁãÄÊÖãÊèêÈÜíÂΩàÁ™ó -->
    {% if status.message %}
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1050;">
        <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="2000" data-bs-autohide="true">
            <div class="toast-header bg-white">
                <strong class="me-auto">ÊªÖÈú∏ÁöÑÁãÄÊÖã</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body bg-{{ status.type }} text-white" style="opacity: 1 !important;">
                {{ status.message }}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ‰ªäÊó•ÊîùÂèñÁµ±Ë®à -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">‰ªäÊó•ÊîùÂèñÁµ±Ë®à</h5>
                    <p>Â∑≤ÊîùÂèñ: {{ "%.1f"|format(total_calories) }} Â§ßÂç° / Âª∫Ë≠∞Èáè: {{ "%.1f"|format(daily_needs) }} Â§ßÂç°</p>
                    <div class="progress mb-3">
                        <div class="progress-bar {% if total_calories > daily_needs %}bg-danger{% endif %}" 
                             role="progressbar" 
                             style="width: {{ (total_calories/daily_needs*100)|round|int if daily_needs > 0 else 0 }}%">
                        </div>
                    </div>
                    <p class="mb-0">{{ remaining_treats }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- È§µÈ£üË®òÈåÑË°®ÂñÆ -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <form action="{{ url_for('add_record') }}" method="post">
                        <div class="row g-3 align-items-center">
                            <div class="col-md">
                                <input type="text" class="form-control" name="feeder_nickname" placeholder="È§µÈ£ü‰∫∫Êö±Á®±" required>
                            </div>
                            <div class="col-md">
                                <select class="form-select" name="food_type" required>
                                    <option value="" selected disabled>ÈÅ∏ÊìáÈ£üÁâ©È°ûÂûã</option>
                                    {% for food in food_types %}
                                    <option value="{{ food.name }}">{{ food.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md">
                                <div class="input-group">
                                    <input type="number" class="form-control" name="amount" placeholder="‰ªΩÈáè" required>
                                    <span class="input-group-text">ÂÖã</span>
                                </div>
                            </div>
                            <div class="col-md-auto">
                                <button type="submit" class="btn btn-record">Ë®òÈåÑ</button>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col">
                                <input type="text" class="form-control" name="notes" placeholder="ÂÇôË®ªÔºàÈÅ∏Â°´Ôºâ">
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ÊúÄËøëÈ§µÈ£üË®òÈåÑ -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">ÊúÄËøëÈ§µÈ£üË®òÈåÑ</h5>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ÊôÇÈñì</th>
                                    <th>È§µÈ£ü‰∫∫</th>
                                    <th>È£üÁâ©</th>
                                    <th>‰ªΩÈáè</th>
                                    <th>Âç°Ë∑ØÈáå</th>
                                    <th>ÂÇôË®ª</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in records %}
                                <tr>
                                    <td>{{ record.local_time.strftime('%m/%d %H:%M') if record.local_time else record.timestamp.strftime('%m/%d %H:%M') }}</td>
                                    <td>{{ record.feeder_nickname }}</td>
                                    <td>{{ record.food_type }}</td>
                                    <td>{{ record.amount }} {{ record.unit }}</td>
                                    <td>{{ "%.1f"|format(record.calories) }}</td>
                                    <td>{{ record.notes or '' }}</td>
                                    <td>
                                        {% if can_edit_record(record) %}
                                        <div class="btn-group">
                                            <a href="{{ url_for('edit_record', record_id=record.id) }}" class="btn btn-sm btn-outline-primary">Á∑®ËºØ</a>
                                            <form action="{{ url_for('delete_record', record_id=record.id) }}" method="POST" style="display: inline;">
                                                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜË®òÈåÑÂóéÔºü')">Âà™Èô§</button>
                                            </form>
                                        </div>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ÁÖßÁâáÊü•Áúã Modal -->
<div class="modal fade" id="viewPhotoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-0">
                <img src="" class="view-photo-img img-fluid" alt="ÁÖßÁâáÂ§ßÂúñ">
            </div>
            <div class="modal-footer">
                <div class="photo-details text-start flex-grow-1">
                    <p class="mb-1"><strong>ÊãçÊîùÊó•ÊúüÔºö</strong><span class="view-photo-date"></span></p>
                    <p class="mb-1"><strong>ÊãçÊîùËÄÖÔºö</strong><span class="view-photo-photographer"></span></p>
                    <p class="mb-1 view-photo-description-container"><strong>ÊèèËø∞Ôºö</strong><span class="view-photo-description"></span></p>
                </div>
                <a href="#" class="btn btn-primary download-photo" download>‰∏ãËºâÁÖßÁâá</a>
            </div>
        </div>
    </div>
</div>

<!-- ‰∏äÂÇ≥ÁÖßÁâá Modal -->
<div class="modal fade" id="uploadPhotoModal" tabindex="-1" aria-labelledby="uploadPhotoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadPhotoModalLabel">‰∏äÂÇ≥ÊªÖÈú∏ÁöÑÁÖßÁâá</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="uploadPhotoForm" action="{{ url_for('upload_photo') }}" method="post" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="photo" class="form-label">ÈÅ∏ÊìáÁÖßÁâá</label>
                        <input type="file" class="form-control" id="photo" name="photo" accept="image/jpeg,image/png,image/heic" required>
                        <div class="form-text">ÊîØÊè¥ JPG„ÄÅPNG„ÄÅHEIC Ê†ºÂºèÁöÑÁÖßÁâá</div>
                    </div>
                    <div class="mb-3">
                        <label for="dateTaken" class="form-label">ÊãçÊîùÊó•Êúü</label>
                        <input type="date" class="form-control" id="dateTaken" name="date_taken" required>
                    </div>
                    <div class="mb-3">
                        <label for="photographer" class="form-label">ÊãçÊîùËÄÖ</label>
                        <input type="text" class="form-control" id="photographer" name="photographer" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">ÊèèËø∞ÔºàÈÅ∏Â°´Ôºâ</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÂèñÊ∂à</button>
                        <button type="submit" class="btn btn-primary">‰∏äÂÇ≥</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
.carousel-photo {
    height: 300px;
    object-fit: cover;
    border-radius: 1.618rem;
}

.photo-card {
    position: relative;
    width: 100%;
    height: 100%;
    cursor: pointer;
    overflow: hidden;
    border-radius: 1.618rem;
}

.photo-info {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,0.7));
    color: white;
    padding: 1rem;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.photo-card:hover .photo-info {
    opacity: 1;
}

.photo-date, .photo-description {
    margin: 0;
    font-size: 0.9rem;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}

.photo-description {
    margin-top: 0.5rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

#viewPhotoModal .modal-content {
    background-color: rgba(255,255,255,0.95);
}

#viewPhotoModal .modal-body {
    max-height: 80vh;
    display: flex;
    align-items: center;
    justify-content: center;
}

.view-photo-img {
    max-height: 70vh;
    object-fit: contain;
}

.photo-details {
    font-size: 0.9rem;
}

.carousel-control-prev,
.carousel-control-next {
    width: 5%;
    background: rgba(0,0,0,0.3);
}

.carousel-control-prev:hover,
.carousel-control-next:hover {
    background: rgba(0,0,0,0.5);
}

.btn-upload-photo {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background-color: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 1rem;
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
    backdrop-filter: blur(5px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    z-index: 10;
}

.btn-upload-photo:hover {
    background-color: rgba(255, 255, 255, 1);
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    transform: translateY(-1px);
}

.btn-upload-photo i {
    margin-right: 0.5rem;
}

.empty-photo-placeholder {
    height: 300px;
    background-color: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 1.618rem;
}

.card {
    border-radius: 1.618rem;
    overflow: hidden;
}

@media (max-width: 768px) {
    .carousel-photo,
    .photo-card,
    .empty-photo-placeholder,
    .card {
        border-radius: 1.2rem;
    }
    
    .btn-upload-photo {
        border-radius: 0.75rem;
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
    }
}

.modal-content {
    border-radius: 1.618rem;
    border: none;
    overflow: hidden;
}

.modal-header {
    border-bottom: 1px solid rgba(0,0,0,0.1);
    background-color: #f8f9fa;
    padding: 1rem 1.5rem;
}

.modal-body {
    padding: 1.5rem;
}

.modal-footer {
    border-top: 1px solid rgba(0,0,0,0.1);
    padding: 1rem 1.5rem;
}

.form-control {
    border-radius: 1rem;
    border: 1px solid rgba(0,0,0,0.1);
    padding: 0.75rem 1rem;
    transition: all 0.3s ease;
    background-color: #f8f9fa;
}

.form-control:focus {
    border-color: rgba(0,0,0,0.2);
    box-shadow: 0 0 0 0.2rem rgba(0,0,0,0.05);
    background-color: white;
}

.form-select {
    border-radius: 1rem;
    border: 1px solid rgba(0,0,0,0.1);
    padding: 0.75rem 1rem;
    transition: all 0.3s ease;
    background-color: #f8f9fa;
    cursor: pointer;
}

.form-select:focus {
    border-color: rgba(0,0,0,0.2);
    box-shadow: 0 0 0 0.2rem rgba(0,0,0,0.05);
    background-color: white;
}

.input-group {
    border-radius: 1rem;
    overflow: hidden;
    background-color: #f8f9fa;
    border: 1px solid rgba(0,0,0,0.1);
}

.input-group .form-control {
    border-radius: 0;
    border: none;
    border-right: none;
    background-color: #f8f9fa;
}

.input-group .form-control:focus {
    border: none;
    background-color: white;
    box-shadow: none;
}

.input-group-text {
    border: none;
    background-color: #f8f9fa;
    color: #212529;
    padding: 0.75rem 1rem;
    border-left: 1px solid rgba(0,0,0,0.1);
}

.input-group:focus-within {
    border-color: rgba(0,0,0,0.2);
    box-shadow: 0 0 0 0.2rem rgba(0,0,0,0.05);
}

.input-group:focus-within .input-group-text {
    background-color: white;
}

.btn-record {
    border-radius: 1.618rem;
    padding: 0.75rem 2rem;
    font-size: 1rem;
    font-weight: 500;
    background-color: #0d6efd;
    border: none;
    color: white;
    transition: all 0.3s ease;
    min-width: 120px;
}

.btn-record:hover {
    background-color: #0b5ed7;
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
}

@media (max-width: 768px) {
    .form-control,
    .form-select {
        border-radius: 0.75rem;
        font-size: 0.9rem;
        padding: 0.5rem 0.75rem;
    }
    
    .input-group {
        border-radius: 0.75rem;
    }
    
    .input-group-text {
        padding: 0.5rem 0.75rem;
        font-size: 0.9rem;
    }
    
    .btn-record {
        border-radius: 1.2rem;
        padding: 0.5rem 1.5rem;
        font-size: 0.9rem;
        min-width: 100px;
    }
}

#uploadPhotoModal .btn {
    border-radius: 0.75rem;
    padding: 0.5rem 1.25rem;
    transition: all 0.3s ease;
}

#uploadPhotoModal .btn-primary {
    background-color: #0d6efd;
    border: none;
}

#uploadPhotoModal .btn-primary:hover {
    background-color: #0b5ed7;
    transform: translateY(-1px);
}

#uploadPhotoModal .btn-secondary {
    background-color: #f8f9fa;
    border: 1px solid rgba(0,0,0,0.1);
    color: #212529;
}

#uploadPhotoModal .btn-secondary:hover {
    background-color: #e9ecef;
    transform: translateY(-1px);
}

@media (max-width: 768px) {
    .modal-content {
        border-radius: 1.2rem;
    }
    
    .form-control {
        border-radius: 0.75rem;
    }
    
    #uploadPhotoModal .btn {
        border-radius: 0.75rem;
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
    }
}

.form-control[type="file"] {
    padding: 0;
    border-radius: 1rem;
    border: 1px dashed rgba(0,0,0,0.2);
    background-color: #f8f9fa;
}

.form-control[type="file"]::file-selector-button {
    border: none;
    border-right: 1px solid rgba(0,0,0,0.1);
    border-top-left-radius: 1rem;
    border-bottom-left-radius: 1rem;
    padding: 0.75rem 1.5rem;
    margin-right: 1rem;
    background-color: #0d6efd;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 120px;
}

.form-control[type="file"]::file-selector-button:hover {
    background-color: #0b5ed7;
}

.form-control[type="file"]::-webkit-file-upload-button {
    border: none;
    border-right: 1px solid rgba(0,0,0,0.1);
    border-top-left-radius: 1rem;
    border-bottom-left-radius: 1rem;
    padding: 0.75rem 1.5rem;
    margin-right: 1rem;
    background-color: #0d6efd;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 120px;
}

.form-control[type="file"]::-webkit-file-upload-button:hover {
    background-color: #0b5ed7;
}

@media (max-width: 768px) {
    .form-control[type="file"] {
        border-radius: 0.75rem;
        font-size: 0.85rem;
    }
    
    .form-control[type="file"]::file-selector-button,
    .form-control[type="file"]::-webkit-file-upload-button {
        border-top-left-radius: 0.75rem;
        border-bottom-left-radius: 0.75rem;
        padding: 0.5rem 1rem;
        min-width: 100px;
        font-size: 0.85rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const viewModal = document.getElementById('viewPhotoModal');
    viewModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const photoSrc = button.getAttribute('data-photo-src');
        const photoDate = button.getAttribute('data-photo-date');
        const photoPhotographer = button.getAttribute('data-photo-photographer');
        const photoDescription = button.getAttribute('data-photo-description');
        const photoFilename = button.getAttribute('data-photo-filename');

        const modalImg = viewModal.querySelector('.view-photo-img');
        const modalDate = viewModal.querySelector('.view-photo-date');
        const modalPhotographer = viewModal.querySelector('.view-photo-photographer');
        const modalDescription = viewModal.querySelector('.view-photo-description');
        const modalDescriptionContainer = viewModal.querySelector('.view-photo-description-container');
        const downloadBtn = viewModal.querySelector('.download-photo');

        modalImg.src = photoSrc;
        modalDate.textContent = photoDate;
        modalPhotographer.textContent = photoPhotographer;
        
        if (photoDescription) {
            modalDescription.textContent = photoDescription;
            modalDescriptionContainer.style.display = 'block';
        } else {
            modalDescriptionContainer.style.display = 'none';
        }

        downloadBtn.href = photoSrc;
        downloadBtn.download = photoFilename;
    });

    // Ëá™ÂãïËº™Êí≠Ë®≠ÂÆö
    const carousel = new bootstrap.Carousel(document.getElementById('recentPhotosCarousel'), {
        interval: 5000,  // 5ÁßíÂàáÊèõ‰∏ÄÊ¨°
        wrap: true
    });

    // Ë®≠ÂÆöÈ†êË®≠ÁöÑÊãçÊîùÊó•ÊúüÁÇ∫‰ªäÂ§©
    const dateTaken = document.getElementById('dateTaken');
    if (dateTaken) {
        const today = new Date().toISOString().split('T')[0];
        dateTaken.value = today;
    }

    // ‰∏äÂÇ≥Ë°®ÂñÆÊèê‰∫§ÂâçÁöÑËôïÁêÜ
    const uploadForm = document.getElementById('uploadPhotoForm');
    if (uploadForm) {
        uploadForm.addEventListener('submit', function(e) {
            const submitButton = this.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ‰∏äÂÇ≥‰∏≠...';
        });
    }
});
</script>
{% endblock %}